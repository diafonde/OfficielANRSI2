<div class="article-form-page">
  <div class="page-header">
    <div class="header-content">
      <h1>{{ isEditMode ? 'Edit Article' : 'Create New Article' }}</h1>
      <p>{{ isEditMode ? 'Update article information' : 'Add a new article with translations' }}</p>
    </div>
    <div class="header-actions">
      <button type="button" (click)="onCancel()" class="btn btn-outline">
        <i class="fas fa-times"></i>
        Cancel
      </button>
    </div>
  </div>

  <form [formGroup]="articleForm" (ngSubmit)="onSubmit()" class="article-form">
    
    <!-- Language Tabs -->
    <div class="language-tabs">
      <button
        *ngFor="let lang of languages"
        type="button"
        class="lang-tab"
        [class.active]="activeLanguage === lang.code"
        [class.has-content]="hasTranslation(lang.code)"
        [class.valid]="isLanguageFormValid(lang.code)"
        (click)="switchLanguage(lang.code)">
        <span class="lang-flag">{{ lang.flag }}</span>
        <span class="lang-name">{{ lang.name }}</span>
        <span class="lang-status">
          <i *ngIf="isLanguageFormValid(lang.code)" class="fas fa-check-circle"></i>
          <i *ngIf="!isLanguageFormValid(lang.code) && hasTranslation(lang.code)" class="fas fa-exclamation-circle"></i>
        </span>
      </button>
    </div>

    <div class="form-grid">
      <!-- Shared Fields Section -->
      <div class="form-section shared-fields">
        <h2>Shared Information</h2>
        
        <div class="form-group">
          <label for="author">Author *</label>
          <input
            type="text"
            id="author"
            formControlName="author"
            class="form-control"
            [class.error]="getFieldError('author')"
            placeholder="Author name"
          >
          <div class="error-message" *ngIf="getFieldError('author')">
            {{ getFieldError('author') }}
          </div>
        </div>

        <div class="form-group">
          <label for="category">Category *</label>
          <select
            id="category"
            formControlName="category"
            class="form-control"
            [class.error]="getFieldError('category')"
          >
            <option value="">Select a category</option>
            <option *ngFor="let category of getCategories()" [value]="category">
              {{ category }}
            </option>
          </select>
          <div class="error-message" *ngIf="getFieldError('category')">
            {{ getFieldError('category') }}
          </div>
        </div>

        <div class="form-group">
          <label for="imageFile">Images *</label>
          <div class="images-container">
            <!-- Existing Images List -->
            <div class="images-list" *ngIf="images.length > 0">
              <div class="image-item" *ngFor="let image of images; let i = index">
                <div class="image-preview-wrapper">
                  <img [src]="image.preview || image.url" alt="Preview" class="preview-image-small" *ngIf="image.preview || image.url">
                  <div class="image-placeholder" *ngIf="!image.preview && !image.url">
                    <i class="fas fa-image"></i>
                  </div>
                  <button type="button" class="remove-image-btn" (click)="removeImage(image.id)" title="Remove image">
                    <i class="fas fa-times"></i>
                  </button>
                  <div class="image-badge" *ngIf="i === 0 && (image.preview || image.url)">
                    <i class="fas fa-star"></i> Featured
                  </div>
                </div>
                <div class="image-upload-progress" *ngIf="image.isUploading">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="image.uploadProgress || 0"></div>
                  </div>
                  <span>Uploading... {{ image.uploadProgress || 0 }}%</span>
                </div>
                <div class="image-url-input" *ngIf="!image.file || !image.url">
                  <input
                    type="url"
                    [id]="'imageUrlInput-' + image.id"
                    [value]="image.urlFallback || image.url"
                    (input)="onUrlInputChange($event, image.id)"
                    (blur)="onUrlInput(image.id)"
                    class="form-control url-input-small"
                    placeholder="https://example.com/image.jpg"
                  >
                </div>
              </div>
            </div>

            <!-- Upload Area -->
            <div class="file-upload-container">
              <input
                type="file"
                id="imageFile"
                accept="image/*"
                multiple
                (change)="onImageSelected($event)"
                class="file-input"
                [class.error]="getFieldError('imageUrl') && images.length === 0"
              >
              <div class="file-upload-placeholder" *ngIf="images.length === 0">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Click to upload images or drag and drop</span>
                <small>PNG, JPG, GIF up to 10MB each. You can select multiple files.</small>
              </div>
              <div class="file-upload-placeholder add-more" *ngIf="images.length > 0">
                <i class="fas fa-plus-circle"></i>
                <span>Click to add more images</span>
                <small>Select multiple files to add them all at once</small>
              </div>
            </div>

            <!-- Add URL Button -->
            <button type="button" class="btn-add-url" (click)="addImageFromUrl()" *ngIf="images.length > 0">
              <i class="fas fa-link"></i>
              Add Image from URL
            </button>
          </div>
          <input
            type="hidden"
            formControlName="imageUrl"
          >
          <div class="error-message" *ngIf="(getFieldError('imageUrl') || errorMessage) && images.length === 0">
            {{ getFieldError('imageUrl') || errorMessage }}
          </div>
          <div class="form-help" *ngIf="!getFieldError('imageUrl') && !errorMessage && images.length === 0">
            Upload image files (PNG, JPG, GIF) or add images via URL. At least one image is required.
          </div>
          <div class="form-help" *ngIf="images.length > 0">
            {{ images.length }} image(s) added. The first image will be used as the featured image.
          </div>
        </div>

        <div class="form-group">
          <label for="publishDate">Publish Date *</label>
          <input
            type="date"
            id="publishDate"
            formControlName="publishDate"
            class="form-control"
            [class.error]="getFieldError('publishDate')"
          >
          <div class="error-message" *ngIf="getFieldError('publishDate')">
            {{ getFieldError('publishDate') }}
          </div>
        </div>

        <div class="form-group">
          <label for="tags">Tags *</label>
          <input
            type="text"
            id="tags"
            formControlName="tags"
            class="form-control"
            [class.error]="getFieldError('tags')"
            placeholder="tag1, tag2, tag3"
          >
          <div class="error-message" *ngIf="getFieldError('tags')">
            {{ getFieldError('tags') }}
          </div>
          <div class="form-help">
            Separate multiple tags with commas
          </div>
        </div>

        <div class="form-group">
          <label for="attachmentFile">Attachment (Optional)</label>
          <div class="file-upload-container attachment-upload">
            <input
              type="file"
              id="attachmentFile"
              accept=".pdf,.doc,.docx,.txt,.xls,.xlsx"
              (change)="onAttachmentSelected($event)"
              class="file-input"
            >
            <div class="file-upload-placeholder" *ngIf="!attachmentFile && !attachmentUrl">
              <i class="fas fa-file-upload"></i>
              <span>Click to upload a file</span>
              <small>PDF, DOC, DOCX, TXT, XLS, XLSX up to 20MB</small>
            </div>
            <div class="file-upload-info" *ngIf="attachmentFile || attachmentUrl">
              <i class="fas fa-file" 
                 [class.fa-file-pdf]="isPdfFile(attachmentFile?.name || attachmentUrl)" 
                 [class.fa-file-word]="isWordFile(attachmentFile?.name || attachmentUrl)"
                 [class.fa-file-excel]="isExcelFile(attachmentFile?.name || attachmentUrl)"></i>
              <span>{{ attachmentFile?.name || getFileNameFromUrl(attachmentUrl) }}</span>
              <span class="file-size" *ngIf="attachmentFile">
                ({{ formatFileSize(attachmentFile.size) }})
              </span>
              <button type="button" class="remove-file" (click)="removeAttachment()" title="Remove file">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="upload-progress" *ngIf="isUploadingAttachment">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="attachmentUploadProgress"></div>
              </div>
              <span>Uploading... {{ attachmentUploadProgress }}%</span>
            </div>
          </div>
          <input
            type="hidden"
            formControlName="attachmentUrl"
          >
          <div class="error-message" *ngIf="attachmentErrorMessage">
            {{ attachmentErrorMessage }}
          </div>
          <div class="url-fallback" *ngIf="!attachmentFile">
            <label for="attachmentUrlInput">Or enter file URL:</label>
            <input
              type="url"
              id="attachmentUrlInput"
              [value]="attachmentUrlFallback"
              (input)="onAttachmentUrlInputChange($event)"
              (blur)="onAttachmentUrlInput()"
              class="form-control url-input"
              placeholder="https://example.com/document.pdf"
            >
          </div>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" formControlName="featured">
            Featured Article
          </label>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" formControlName="published" [checked]="true">
            Published
          </label>
        </div>
      </div>

      <!-- Language-Specific Content (Tabbed) -->
      <div class="form-section translation-content">
        <h2>Content - {{ getActiveLanguageName() }}</h2>
        
        <div [formGroup]="getActiveTranslationFormGroup()">
          <div class="form-group">
            <label [attr.for]="'title-' + activeLanguage">Title *</label>
            <input
              [attr.id]="'title-' + activeLanguage"
              type="text"
              formControlName="title"
              class="form-control"
              [class.error]="getFieldError('title', activeLanguage)"
              [attr.placeholder]="'Enter article title in ' + getActiveLanguageName()"
            >
            <div class="error-message" *ngIf="getFieldError('title', activeLanguage)">
              {{ getFieldError('title', activeLanguage) }}
            </div>
          </div>

          <div class="form-group">
            <label [attr.for]="'excerpt-' + activeLanguage">Excerpt *</label>
            <textarea
              [attr.id]="'excerpt-' + activeLanguage"
              formControlName="excerpt"
              class="form-control"
              [class.error]="getFieldError('excerpt', activeLanguage)"
              [attr.placeholder]="'Brief description in ' + getActiveLanguageName()"
              rows="3"
            ></textarea>
            <div class="error-message" *ngIf="getFieldError('excerpt', activeLanguage)">
              {{ getFieldError('excerpt', activeLanguage) }}
            </div>
          </div>

          <div class="form-group">
            <label [attr.for]="'content-' + activeLanguage">Content *</label>
            <textarea
              [attr.id]="'content-' + activeLanguage"
              formControlName="content"
              class="form-control content-textarea"
              [class.error]="getFieldError('content', activeLanguage)"
              [attr.placeholder]="'Write your article content in ' + getActiveLanguageName()"
              rows="15"
            ></textarea>
            <div class="error-message" *ngIf="getFieldError('content', activeLanguage)">
              {{ getFieldError('content', activeLanguage) }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <div class="error-message general-error" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>
      
      <div class="translation-summary">
        <div class="summary-item" *ngFor="let lang of languages">
          <span class="lang-flag">{{ lang.flag }}</span>
          <span class="lang-name">{{ lang.name }}:</span>
          <span [class]="'status ' + (isLanguageFormValid(lang.code) ? 'complete' : 'incomplete')">
            {{ isLanguageFormValid(lang.code) ? 'Complete' : 'Incomplete' }}
          </span>
        </div>
      </div>
      
      <div class="action-buttons">
        <button type="button" (click)="onCancel()" class="btn btn-outline">
          Cancel
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="isLoading"
        >
          <span *ngIf="isLoading" class="spinner"></span>
          {{ isLoading ? 'Saving...' : (isEditMode ? 'Update Article' : 'Create Article') }}
        </button>
      </div>
    </div>
  </form>
</div>
