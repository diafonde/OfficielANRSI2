<div class="admin-appels-candidatures-form">
  <div class="form-header">
    <h1>{{ getLabel('editPage') }}</h1>
    <div class="header-actions">
      <button (click)="loadPage()" class="btn btn-secondary btn-sm" [disabled]="isLoading" title="Recharger les données">
        <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i> Actualiser
      </button>
      <button (click)="onCancel()" class="btn btn-secondary">
        <i class="fas fa-times"></i> {{ getLabel('cancel') }}
      </button>
    </div>
  </div>

  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>

  <div *ngIf="isLoading" class="loading">
    <i class="fas fa-spinner fa-spin"></i> {{ getLabel('loading') }}
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" *ngIf="!isLoading">
    <!-- Language Tabs -->
    <div class="language-tabs-container">
      <div class="language-tabs">
        <button
          *ngFor="let lang of languages"
          type="button"
          class="lang-tab"
          [class.active]="activeLanguage === lang.code"
          [class.has-content]="hasTranslation(lang.code)"
          [class.valid]="isLanguageFormValid(lang.code)"
          (click)="switchLanguage(lang.code)">
          <span class="lang-flag">{{ lang.flag }}</span>
          <span class="lang-name">{{ lang.name }}</span>
          <span class="lang-status">
            <i *ngIf="isLanguageFormValid(lang.code)" class="fas fa-check-circle" title="Complet"></i>
            <i *ngIf="!isLanguageFormValid(lang.code) && hasTranslation(lang.code)" class="fas fa-exclamation-circle" title="Incomplet"></i>
          </span>
        </button>
      </div>
      <div class="translation-helpers" *ngIf="activeLanguage !== 'fr'">
        <button 
          type="button" 
          class="btn btn-sm btn-secondary"
          (click)="copyFromFrench()"
          title="Copier le contenu du français vers {{ getActiveLanguageName() }}">
          <i class="fas fa-copy"></i> Copier depuis le français
        </button>
      </div>
    </div>
    <div class="translation-info" *ngIf="activeLanguage !== 'fr'">
      <i class="fas fa-info-circle"></i>
      <span>
        <strong>Mode traduction :</strong> Vous éditez actuellement la version {{ getActiveLanguageName() }}. 
        Tous les champs que vous remplissez seront affichés lorsque les visiteurs sélectionnent cette langue sur le site.
      </span>
    </div>

    <div class="form-section">
      <div class="section-header">
        <h2>Appels à Candidatures - {{ getActiveLanguageName() }}</h2>
        <div class="header-actions">
          <input
            type="file"
            id="jsonFileInput"
            accept=".json"
            (change)="onJsonFileSelected($event)"
            class="file-input"
            style="display: none;"
            [disabled]="isImporting"
            #jsonFileInput
          >
          <button 
            type="button" 
            (click)="jsonFileInput.click()" 
            class="btn btn-secondary"
            [disabled]="isImporting"
            title="Importer un fichier JSON">
            <i class="fas fa-file-import"></i> {{ getLabel('importJson') }}
          </button>
          <button type="button" (click)="addAppel()" class="btn btn-primary">
            <i class="fas fa-plus"></i> {{ getLabel('addAppel') }}
          </button>
        </div>
      </div>
      <p class="section-description">Gérez les appels à candidatures affichés sur la page publique</p>
      
      <div *ngIf="isImporting" class="import-progress-container">
        <div class="import-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="importProgress"></div>
          </div>
          <span><i class="fas fa-spinner fa-spin"></i> {{ getLabel('importing') }}</span>
        </div>
        <p class="import-info">Les images seront téléchargées automatiquement...</p>
      </div>

      <div [formGroup]="getActiveLanguageFormGroup()">
        <!-- Pagination Info and Controls (Top) -->
        <div class="pagination-header" *ngIf="totalItems > 0">
          <div class="pagination-info">
            <span>Affichage de {{ startIndex }} à {{ endIndex }} sur {{ totalItems }} appels</span>
            <select 
              [value]="itemsPerPage" 
              (change)="onItemsPerPageChange($event)"
              class="items-per-page-select">
              <option value="5">5 par page</option>
              <option value="10">10 par page</option>
              <option value="20">20 par page</option>
              <option value="50">50 par page</option>
            </select>
          </div>
        </div>

        <div formArrayName="appels" class="appels-list-container">
          <div *ngFor="let appel of paginatedAppels; let i = index" 
               [formGroupName]="(currentPage - 1) * itemsPerPage + i" 
               class="appel-card">
            <div class="card-header">
              <h3>Appel #{{ (currentPage - 1) * itemsPerPage + i + 1 }}</h3>
              <button type="button" (click)="removeAppel((currentPage - 1) * itemsPerPage + i)" class="btn btn-danger btn-sm" *ngIf="appels.length > 1">
                <i class="fas fa-trash"></i> {{ getLabel('remove') }}
              </button>
            </div>

            <div class="form-group">
              <label>Titre</label>
              <input 
                type="text" 
                formControlName="title" 
                class="form-control" 
                [placeholder]="activeLanguage === 'fr' ? 'Ex: Appel à candidature pour une bourses doctorales d\'excellence 2021-2022' : (activeLanguage === 'ar' ? 'مثال: دعوة للتقديم على منح الدكتوراه المتميزة 2021-2022' : 'Ex: Call for applications for excellence doctoral scholarships 2021-2022')" />
            </div>

            <div class="form-group">
              <label>URL</label>
              <input 
                type="text" 
                formControlName="url" 
                class="form-control" 
                placeholder="https://anrsi.mr/fr/?q=fr/node/1270" />
            </div>

            <div class="form-group">
              <label>Image</label>
              <div class="image-upload-container">
                <input
                  type="file"
                  [id]="'imageFile-' + activeLanguage + '-' + ((currentPage - 1) * itemsPerPage + i)"
                  accept="image/*"
                  (change)="onImageSelected($event, (currentPage - 1) * itemsPerPage + i)"
                  class="file-input"
                  style="display: none;"
                  #imageFileInput
                >
                <div class="image-preview" *ngIf="getImageUploadState((currentPage - 1) * itemsPerPage + i).preview || appel.get('image')?.value">
                  <img [src]="getImageUploadState((currentPage - 1) * itemsPerPage + i).preview || appel.get('image')?.value" alt="Preview" class="preview-image">
                  <button type="button" class="remove-image" (click)="removeImage((currentPage - 1) * itemsPerPage + i)" title="Supprimer l'image">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="file-upload-placeholder" *ngIf="!getImageUploadState((currentPage - 1) * itemsPerPage + i).preview && !appel.get('image')?.value && !getImageUploadState((currentPage - 1) * itemsPerPage + i).file">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>Cliquez pour télécharger une image</span>
                  <small>PNG, JPG, GIF jusqu'à 10MB</small>
                  <button type="button" class="btn btn-sm btn-primary mt-2" (click)="imageFileInput.click()">
                    <i class="fas fa-upload"></i> Télécharger une image
                  </button>
                </div>
                <div class="upload-progress" *ngIf="getImageUploadState((currentPage - 1) * itemsPerPage + i).isUploading">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="getImageUploadState((currentPage - 1) * itemsPerPage + i).uploadProgress || 0"></div>
                  </div>
                  <span>Téléchargement... {{ getImageUploadState((currentPage - 1) * itemsPerPage + i).uploadProgress || 0 }}%</span>
                </div>
                <div class="image-url-input" *ngIf="appel.get('image')?.value && !getImageUploadState((currentPage - 1) * itemsPerPage + i).isUploading">
                  <input type="text" formControlName="image" class="form-control" placeholder="Ou entrez une URL d'image" />
                  <button type="button" class="btn btn-sm btn-secondary mt-2" (click)="imageFileInput.click()">
                    <i class="fas fa-upload"></i> Remplacer par un fichier
                  </button>
                </div>
                <div class="image-url-input" *ngIf="!appel.get('image')?.value && !getImageUploadState((currentPage - 1) * itemsPerPage + i).preview && !getImageUploadState((currentPage - 1) * itemsPerPage + i).isUploading">
                  <input type="text" formControlName="image" class="form-control" placeholder="Ou entrez une URL d'image" />
                  <button type="button" class="btn btn-sm btn-primary mt-2" (click)="imageFileInput.click()">
                    <i class="fas fa-upload"></i> Télécharger un fichier
                  </button>
                </div>
              </div>
              <small class="form-text text-muted">Téléchargez une image ou entrez une URL d'image</small>
            </div>

            <div class="form-group">
              <label>Résumé</label>
              <textarea 
                formControlName="summary" 
                class="form-control" 
                rows="4" 
                [placeholder]="activeLanguage === 'fr' ? 'Résumé court de l\'appel à candidatures...' : (activeLanguage === 'ar' ? 'ملخص قصير لدعوة التقديم...' : 'Short summary of the call for applications...')"></textarea>
              <small class="form-text text-muted">Texte court affiché dans la liste</small>
            </div>

            <div class="form-group">
              <label>Date</label>
              <input 
                type="text" 
                formControlName="date" 
                class="form-control" 
                [placeholder]="activeLanguage === 'fr' ? 'Ex: 9 February 2022' : (activeLanguage === 'ar' ? 'مثال: 9 فبراير 2022' : 'Ex: 9 February 2022')" />
              <small class="form-text text-muted">Format: DD Month YYYY (ex: 9 February 2022)</small>
            </div>

            <div class="form-group">
              <label>Texte Complet</label>
              <textarea 
                formControlName="full_text" 
                class="form-control" 
                rows="8" 
                [placeholder]="activeLanguage === 'fr' ? 'Texte complet de l\'appel à candidatures...' : (activeLanguage === 'ar' ? 'النص الكامل لدعوة التقديم...' : 'Full text of the call for applications...')"></textarea>
              <small class="form-text text-muted">Texte complet qui sera affiché dans la page de détails</small>
            </div>

            <div class="form-group">
              <label>Document (PDF, Word, Excel)</label>
              <div class="document-upload-container">
                <input
                  type="file"
                  [id]="'documentFile-' + activeLanguage + '-' + ((currentPage - 1) * itemsPerPage + i)"
                  accept=".pdf,.doc,.docx,.xls,.xlsx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                  (change)="onDocumentSelected($event, (currentPage - 1) * itemsPerPage + i)"
                  class="file-input"
                  style="display: none;"
                  #documentFileInput
                />
                <div class="document-upload-options">
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-primary"
                    (click)="documentFileInput.click()"
                    [disabled]="getDocumentUploadState((currentPage - 1) * itemsPerPage + i).isUploading">
                    <i class="fas fa-file-upload"></i> 
                    <span *ngIf="!getDocumentUploadState((currentPage - 1) * itemsPerPage + i).isUploading">Télécharger un document</span>
                    <span *ngIf="getDocumentUploadState((currentPage - 1) * itemsPerPage + i).isUploading">Téléchargement...</span>
                  </button>
                  <span class="document-info" *ngIf="getDocumentUploadState((currentPage - 1) * itemsPerPage + i).fileName && !getDocumentUploadState((currentPage - 1) * itemsPerPage + i).isUploading">
                    <i class="fas fa-file"></i> {{ getDocumentUploadState((currentPage - 1) * itemsPerPage + i).fileName }}
                  </span>
                  <span class="document-url" *ngIf="appel.get('documentUrl')?.value && !getDocumentUploadState((currentPage - 1) * itemsPerPage + i).isUploading">
                    <i class="fas fa-link"></i> Document téléchargé
                    <button type="button" class="btn btn-sm btn-link text-danger" (click)="removeDocument((currentPage - 1) * itemsPerPage + i)" title="Supprimer le document">
                      <i class="fas fa-times"></i>
                    </button>
                  </span>
                </div>
                <div class="upload-progress" *ngIf="getDocumentUploadState((currentPage - 1) * itemsPerPage + i).isUploading">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="getDocumentUploadState((currentPage - 1) * itemsPerPage + i).uploadProgress || 0"></div>
                  </div>
                  <span>Téléchargement... {{ getDocumentUploadState((currentPage - 1) * itemsPerPage + i).uploadProgress || 0 }}%</span>
                </div>
              </div>
              <small class="form-text text-muted">Téléchargez un document (PDF, Word, Excel - max 50MB)</small>
            </div>
          </div>
        </div>

        <!-- Pagination Controls (Bottom) -->
        <div class="pagination-controls" *ngIf="totalPages > 1">
          <button 
            type="button" 
            class="btn btn-secondary btn-sm"
            (click)="previousPage()"
            [disabled]="currentPage === 1"
            title="Page précédente">
            <i class="fas fa-chevron-left"></i> Précédent
          </button>
          
          <div class="page-numbers">
            <button
              *ngFor="let page of getPageNumbers()"
              type="button"
              class="btn btn-sm"
              [class.btn-primary]="page === currentPage"
              [class.btn-secondary]="page !== currentPage"
              [class.ellipsis]="page === '...'"
              [disabled]="page === '...'"
              (click)="onPageNumberClick(page)">
              {{ page }}
            </button>
          </div>
          
          <button 
            type="button" 
            class="btn btn-secondary btn-sm"
            (click)="nextPage()"
            [disabled]="currentPage === totalPages"
            title="Page suivante">
            Suivant <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <div *ngIf="appels.length === 0" class="empty-state">
        <p>Aucun appel à candidatures. Cliquez sur "{{ getLabel('addAppel') }}" pour commencer.</p>
      </div>
    </div>

    <div class="form-actions">
      <div class="translation-summary">
        <div class="summary-item" *ngFor="let lang of languages">
          <span class="lang-flag">{{ lang.flag }}</span>
          <span class="lang-name">{{ lang.name }}:</span>
          <span [class]="'status ' + (isLanguageFormValid(lang.code) ? 'complete' : 'incomplete')">
            {{ isLanguageFormValid(lang.code) ? getLabel('complete') : getLabel('incomplete') }}
          </span>
        </div>
      </div>
      <div class="action-buttons">
        <button type="button" (click)="onCancel()" class="btn btn-secondary">{{ getLabel('cancel') }}</button>
        <button type="submit" class="btn btn-primary" [disabled]="isSaving || form.invalid">
          <i class="fas fa-save"></i> {{ isSaving ? getLabel('saving') : getLabel('saveChanges') }}
        </button>
      </div>
    </div>
  </form>
</div>
